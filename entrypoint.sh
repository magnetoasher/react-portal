#!/bin/sh

cat <<EOF > .env
# App
HOST="${HOST}"
PORT="${PORT}"
PORT_DEBUGGER="${PORT_DEBUGGER}"
SESSION_SECRET="${SESSION_SECRET}"

# DB
DATABASE_CONNECTION="${DATABASE_CONNECTION}"
DATABASE_HOST="${DATABASE_HOST}"
DATABASE_PORT="${DATABASE_PORT}"
DATABASE_USERNAME="${DATABASE_USERNAME}"
DATABASE_PASSWORD="${DATABASE_PASSWORD}"
DATABASE_DATABASE="${DATABASE_DATABASE}"
DATABASE_SCHEMA="${DATABASE_SCHEMA}"
DATABASE_SYNCHRONIZE="${DATABASE_SYNCHRONIZE}"
DATABASE_DROP_SCHEMA="${DATABASE_DROP_SCHEMA}"
DATABASE_MIGRATIONS_RUN="${DATABASE_MIGRATIONS_RUN}"
DATABASE_LOGGING="${DATABASE_LOGGING}"
DATABASE_CACHE="${DATABASE_CACHE}"

# Redis
REDIS_HOST="${REDIS_HOST}"
REDIS_PORT="${REDIS_PORT}"
REDIS_DB="${REDIS_DB}"
REDIS_PASSWORD="${REDIS_PASSWORD}"
REDIS_PREFIX="${REDIS_PREFIX}"

# LDAP
LDAP_URL="${LDAP_URL}"
LDAP_BIND_DN="${LDAP_BIND_DN}"
LDAP_BIND_PW="${LDAP_BIND_PW}"
LDAP_SEARCH_BASE="${LDAP_SEARCH_BASE}"
LDAP_SEARCH_FILTER="${LDAP_SEARCH_FILTER}"
EOF

export NODE=`which node`

if [ -n "$*" -a "$1" = "test" ]; then
  export NODE_ENV=${NODE_ENV:=test}
  node_modules/.bin/jest $2 $3 $4 $5
elif [ -n "$*" -a "$1" = "start" ]; then
  export NODE_ENV=${NODE_ENV:=production}
  $NODE .nest/server/main.js
fi
